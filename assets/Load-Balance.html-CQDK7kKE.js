import{_ as o,c as l,d as n,e as s,a as i,f as t,b as r,r as p,o as d}from"./app-BrzuM4xY.js";const c={};function g(u,e){const a=p("RouteLink");return d(),l("div",null,[e[3]||(e[3]=n("h2",{id:"负载均衡",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#负载均衡"},[n("span",null,"负载均衡")])],-1)),e[4]||(e[4]=n("p",null,"Region 迁移属于高级运维功能，具有一定操作成本，建议完整阅读后再使用该功能。如有疑问请联系 IoTDB 团队寻求技术支持。",-1)),e[5]||(e[5]=n("h3",{id:"功能介绍",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#功能介绍"},[n("span",null,"功能介绍")])],-1)),n("p",null,[e[1]||(e[1]=s("IoTDB 是一个分布式数据库，数据的均衡分布对集群的磁盘空间、写入压力的负载均衡有着重要作用，region 是数据在 IoTDB 集群中进行分布式存储的基本单元，具体概念可见")),i(a,{to:"/zh/UserGuide/V2.0.1/Tree/Background-knowledge/Cluster-Concept.html"},{default:t(()=>e[0]||(e[0]=[s("region")])),_:1}),e[2]||(e[2]=s("。"))]),e[6]||(e[6]=r(`<p>集群正常运行情况下，IoTDB 将会自动对数据进行负载均衡，但在集群新加入 DataNode 节点、DataNode 所在机器硬盘损坏需要恢复数据等场景下，可通过手动 Region 迁移精细化调整集群负载和运维。</p><p>下面是一次region迁移过程的示意图：</p><figure><img src="https://alioss.timecho.com/docs/img/region迁移示意图20241210.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="注意事项" tabindex="-1"><a class="header-anchor" href="#注意事项"><span>注意事项</span></a></h3><ol><li>推荐仅在 IoTDB 1.3.3 以及更高版本使用 Region 迁移功能。</li><li>仅在共识协议为 IoTConsensus、Ratis 时支持 Region 迁移（iotdb-system.properties中的<code>schema_region_consensus_protocol_class</code> 和 <code>data_region_consensus_protocol_class</code>）。</li><li>Region 迁移会占用硬盘和网络带宽等系统资源，推荐在低业务负载时进行。</li><li>在理想情况下，Region 迁移不影响用户侧读写。特殊情况下，Region 迁移可能阻塞写入，这种情况的具体鉴别与处理方式见使用说明。</li></ol><h3 id="使用说明" tabindex="-1"><a class="header-anchor" href="#使用说明"><span>使用说明</span></a></h3><ul><li><p><strong>语法定义</strong>：</p><p>提交一个异步任务，将 region 从一个 DataNode 迁移到另一个 DataNode。</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#ABB2BF;">  migrateRegion</span></span>
<span class="line"><span style="color:#ABB2BF;">      : MIGRATE REGION regionId</span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;">INTEGER_LITERAL </span><span style="color:#C678DD;">FROM</span><span style="color:#ABB2BF;"> fromId</span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;">INTEGER_LITERAL </span><span style="color:#C678DD;">TO</span><span style="color:#ABB2BF;"> toId</span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;">INTEGER_LITERAL</span></span>
<span class="line"><span style="color:#ABB2BF;">      ;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>示例</strong>：</p><p>将 region 1 从 DataNode 2 迁移至 DataNode 3：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#ABB2BF;">  IoTDB</span><span style="color:#56B6C2;">&gt;</span><span style="color:#ABB2BF;"> migrate region </span><span style="color:#D19A66;">1</span><span style="color:#C678DD;"> from</span><span style="color:#D19A66;"> 2</span><span style="color:#C678DD;"> to</span><span style="color:#D19A66;"> 3</span></span>
<span class="line"><span style="color:#ABB2BF;">  Msg: The </span><span style="color:#C678DD;">statement</span><span style="color:#C678DD;"> is</span><span style="color:#ABB2BF;"> executed successfully.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>“The statement is executed successfully” 仅代表region迁移任务提交成功，不代表执行完毕。任务执行情况通过 CLI 指令<code>show regions</code>查看。</p></li><li><p><strong>相关配置项</strong>：</p><ul><li>迁移速度控制：修改<code>iotdb-system.properties</code>参数 <code>region_migration_speed_limit_bytes_per_second</code>控制 region 迁移速度。</li></ul></li><li><p><strong>耗时估算</strong>：</p><ul><li>如果迁移过程无并发写入，那么耗时可以简单通过 region 数据量除以数据传输速度来估算。例如对于 1TB 的 region，硬盘网络带宽和限速参数共同决定数据传输速度是 100MB/s，那么需要约 3 小时完成迁移。</li><li>如果迁移过程有并发写入，那么耗时会有所上升，具体耗时取决于写入压力、系统资源等多方面因素，可简单按无并发写入耗时×1.5来估算。</li></ul></li><li><p><strong>迁移进度观察</strong>：迁移过程中可通过 CLI 指令<code>show regions</code>观察状态变化，以 2 副本为例，region 所在共识组的状态会经历如下过程：</p><ul><li><p>迁移开始前：<code>Running</code>，<code>Running</code>。</p></li><li><p>扩容阶段：<code>Running</code>，<code>Running</code>，<code>Adding</code>。由于涉及到大量文件传输，可能耗时较长，具体进度在 DataNode 日志中搜索<code>[SNAPSHOT TRANSMISSION]</code>。</p></li><li><p>缩容阶段：<code>Removing</code>，<code>Running</code>，<code>Running</code>。</p></li><li><p>迁移完成：<code>Running</code>，<code>Running</code>。</p></li></ul><p>以扩容阶段为例，<code>show regions</code>的结果可能为：</p><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" data-title="plain" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>IoTDB&gt; show regions</span></span>
<span class="line"><span>+--------+------------+-------+--------+-------------+-----------+----------+----------+-------+---------------+--------+-----------------------+</span></span>
<span class="line"><span>|RegionId|        Type| Status|Database|SeriesSlotNum|TimeSlotNum|DataNodeId|RpcAddress|RpcPort|InternalAddress|    Role|             CreateTime|</span></span>
<span class="line"><span>+--------+------------+-------+--------+-------------+-----------+----------+----------+-------+---------------+--------+-----------------------+</span></span>
<span class="line"><span>|       0|SchemaRegion|Running| root.ln|            1|          0|         1|   0.0.0.0|   6668|      127.0.0.1|  Leader|2024-04-15T18:55:17.691|</span></span>
<span class="line"><span>|       0|SchemaRegion|Running| root.ln|            1|          0|         2|   0.0.0.0|   6668|      127.0.0.1|  Leader|2024-04-15T18:55:17.691|</span></span>
<span class="line"><span>|       0|SchemaRegion|Running| root.ln|            1|          0|         3|   0.0.0.0|   6668|      127.0.0.1|  Leader|2024-04-15T18:55:17.691|</span></span>
<span class="line"><span>|       1|  DataRegion|Running| root.ln|            1|          1|         1|   0.0.0.0|   6667|      127.0.0.1|  Leader|2024-04-15T18:55:19.457|</span></span>
<span class="line"><span>|       1|  DataRegion|Running| root.ln|            1|          1|         2|   0.0.0.0|   6668|      127.0.0.1|Follower|2024-04-15T18:55:19.457|</span></span>
<span class="line"><span>|       1|  DataRegion| Adding| root.ln|            1|          1|         3|   0.0.0.0|   6668|      127.0.0.1|Follower|2024-04-15T18:55:19.457|</span></span>
<span class="line"><span>+--------+------------+-------+--------+-------------+-----------+----------+----------+-------+---------------+--------+-----------------------+</span></span>
<span class="line"><span>Total line number = 3</span></span>
<span class="line"><span>It costs 0.003s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>阻塞写入</strong>：</p><p>IoTConsensus 的 region 迁移不直接阻塞写入，但由于过程中需要阻塞 WAL 文件的清理，如果 WAL 文件堆积达到阈值<code>wal_throttle_threshold_in_byte</code>，那么当前 DataNode 会暂停写入，直到 WAL 文件恢复到阈值以下。</p><p>如果迁移过程中由于 WAL 达到阈值造成写入报错（例如报错信息为 The write is rejected because the wal directory size has reached the threshold），可以将<code>wal_throttle_threshold_in_byte</code>调大到 500GB 或更大以允许继续写入。使用 SQL 语句：</p><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" data-title="plain" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>  IoTDB&gt; set configuration &quot;wal_throttle_threshold_in_byte&quot;=&quot;536870912000&quot; </span></span>
<span class="line"><span>  Msg: The statement is executed successfully.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul>`,7))])}const h=o(c,[["render",g],["__file","Load-Balance.html.vue"]]),B=JSON.parse('{"path":"/zh/UserGuide/V2.0.1/Tree/User-Manual/Load-Balance.html","title":"","lang":"zh-CN","frontmatter":{"description":"负载均衡 Region 迁移属于高级运维功能，具有一定操作成本，建议完整阅读后再使用该功能。如有疑问请联系 IoTDB 团队寻求技术支持。 功能介绍 IoTDB 是一个分布式数据库，数据的均衡分布对集群的磁盘空间、写入压力的负载均衡有着重要作用，region 是数据在 IoTDB 集群中进行分布式存储的基本单元，具体概念可见。 集群正常运行情况下，Io...","head":[["link",{"rel":"alternate","hreflang":"en-us","href":"https://iotdb.apache.org/UserGuide/V2.0.1/Tree/User-Manual/Load-Balance.html"}],["meta",{"property":"og:url","content":"https://iotdb.apache.org/zh/UserGuide/V2.0.1/Tree/User-Manual/Load-Balance.html"}],["meta",{"property":"og:site_name","content":"IoTDB Website"}],["meta",{"property":"og:description","content":"负载均衡 Region 迁移属于高级运维功能，具有一定操作成本，建议完整阅读后再使用该功能。如有疑问请联系 IoTDB 团队寻求技术支持。 功能介绍 IoTDB 是一个分布式数据库，数据的均衡分布对集群的磁盘空间、写入压力的负载均衡有着重要作用，region 是数据在 IoTDB 集群中进行分布式存储的基本单元，具体概念可见。 集群正常运行情况下，Io..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://alioss.timecho.com/docs/img/region%E8%BF%81%E7%A7%BB%E7%A4%BA%E6%84%8F%E5%9B%BE20241210.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:locale:alternate","content":"en-US"}],["meta",{"property":"og:updated_time","content":"2025-01-13T04:01:11.000Z"}],["meta",{"property":"article:modified_time","content":"2025-01-13T04:01:11.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"\\",\\"image\\":[\\"https://alioss.timecho.com/docs/img/region%E8%BF%81%E7%A7%BB%E7%A4%BA%E6%84%8F%E5%9B%BE20241210.png\\"],\\"dateModified\\":\\"2025-01-13T04:01:11.000Z\\",\\"author\\":[]}"]]},"headers":[{"level":2,"title":"负载均衡","slug":"负载均衡","link":"#负载均衡","children":[{"level":3,"title":"功能介绍","slug":"功能介绍","link":"#功能介绍","children":[]},{"level":3,"title":"注意事项","slug":"注意事项","link":"#注意事项","children":[]},{"level":3,"title":"使用说明","slug":"使用说明","link":"#使用说明","children":[]}]}],"git":{"createdTime":1736690542000,"updatedTime":1736740871000,"contributors":[{"name":"Li Yu Heng","username":"Li Yu Heng","email":"liyuheng55555@126.com","commits":1,"url":"https://github.com/Li Yu Heng"},{"name":"W1y1r","username":"W1y1r","email":"150988475+W1y1r@users.noreply.github.com","commits":1,"url":"https://github.com/W1y1r"}]},"readingTime":{"minutes":3.74,"words":1122},"filePathRelative":"zh/UserGuide/V2.0.1/Tree/User-Manual/Load-Balance.md","localizedDate":"2025年1月12日","autoDesc":true}');export{h as comp,B as data};
